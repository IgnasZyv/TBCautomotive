@* Pages/CarDetails.razor *@
@page "/car/{CarId}"
@rendermode InteractiveServer
@using CarHostingWeb.Models
@using CarHostingWeb.Services
@using CarHostingWeb.Components.Shared

@inject CarService CarService
@inject NavigationManager NavigationManager

<SectionHeader LocalizationString="CarDetails" IconClassString="bi bi-info-square-fill me-1 text-primary" IsTop="@true"/>

@if (_isLoading)
{
    <div class="d-flex justify-content-center mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_car == null)
{
    <div class="container mt-4">
        <div class="alert alert-danger">
            <h4>Car Not Found</h4>
            <p>The car you're looking for doesn't exist.</p>
            <button class="btn btn-primary" @onclick="GoHome">
                Back to Home
            </button>
        </div>
    </div>
}
else
{
    <div class="container mt-4">
        <div class="row">
            
            <CarImageGallery Car="_car"/>
            
            <div class="col-md-6">
                <h1>@_car.Make @_car.Model (@_car.Year)</h1>
                <h2 class="text-primary mb-4">â‚¬@_car.Price.ToString("N2")</h2>

                <!-- Basic Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-car-front me-2"></i>Vehicle Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-4"><strong>Make:</strong></div>
                            <div class="col-8">@_car.Make</div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-4"><strong>Model:</strong></div>
                            <div class="col-8">@_car.Model</div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-4"><strong>Year:</strong></div>
                            <div class="col-8">@_car.Year</div>
                        </div>

                        @if (_car.Condition.HasValue)
                        {
                            <div class="row mb-2">
                                <div class="col-4"><strong>Condition:</strong></div>
                                <div class="col-8">
                                    <span class="badge @GetConditionBadgeClass(_car.Condition.Value)">
                                        @GetConditionDisplayName(_car.Condition.Value)
                                    </span>
                                </div>
                            </div>
                        }

                        @if (_car.Kilometres.HasValue)
                        {
                            <div class="row mb-2">
                                <div class="col-4"><strong>Kilometres:</strong></div>
                                <div class="col-8">@_car.Kilometres.Value.ToString("N0") km</div>
                            </div>
                        }

                        <div class="row mb-2">
                            <div class="col-4"><strong>Listed:</strong></div>
                            <div class="col-8">@_car.CreatedAt.ToDateTime().ToString("MMMM dd, yyyy")</div>
                        </div>
                    </div>
                </div>

                <!-- Engine & Performance -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Engine & Performance</h5>
                    </div>
                    <div class="card-body">
                        @if (_car.FuelType.HasValue)
                        {
                            <div class="row mb-2">
                                <div class="col-4"><strong>Fuel Type:</strong></div>
                                <div class="col-8">@GetFuelTypeDisplayName(_car.FuelType.Value)</div>
                            </div>
                        }

                        @if (_car.Transmission.HasValue)
                        {
                            <div class="row mb-2">
                                <div class="col-4"><strong>Transmission:</strong></div>
                                <div class="col-8">@GetTransmissionDisplayName(_car.Transmission.Value)</div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(_car.EngineSize))
                        {
                            <div class="row mb-2">
                                <div class="col-4"><strong>Engine Size:</strong></div>
                                <div class="col-8">@_car.EngineSize</div>
                            </div>
                        }

                        @if (_car.EngineCylinders.HasValue)
                        {
                            <div class="row mb-2">
                                <div class="col-4"><strong>Cylinders:</strong></div>
                                <div class="col-8">@_car.EngineCylinders.Value</div>
                            </div>
                        }

                        @if (_car.Horsepower.HasValue)
                        {
                            <div class="row mb-2">
                                <div class="col-4"><strong>Horsepower:</strong></div>
                                <div class="col-8">@_car.Horsepower.Value HP</div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Features -->
                @if (_car.Features?.Any() == true)
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-star me-2"></i>Features</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                @foreach (var feature in _car.Features)
                                {
                                    <div class="col-6 mb-2">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>@feature
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Description -->
                @if (!string.IsNullOrEmpty(_car.Description))
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Description</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">@_car.Description</p>
                        </div>
                    </div>
                }

                <!-- Action Buttons -->
                <div class="mt-4">
                    <button class="btn btn-primary btn-lg me-2">
                        <i class="bi bi-envelope me-2"></i>Contact Seller
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="GoHome">
                        <i class="bi bi-arrow-left me-2"></i>Back to Listings
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string CarId { get; set; } = string.Empty;
    
    private Car? _car;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!string.IsNullOrEmpty(CarId))
            {
                _car = await CarService.GetCarByIdAsync(CarId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($@"Error loading car: {ex.Message}");
            _car = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void GoHome()
    {
        NavigationManager.NavigateTo("/");
    }

    // Helper methods for display names
    private string GetConditionDisplayName(VehicleCondition condition)
    {
        return condition switch
        {
            VehicleCondition.New => "New",
            VehicleCondition.Used => "Used",
            VehicleCondition.CertifiedPreOwned => "Certified Pre-Owned",
            _ => condition.ToString()
        };
    }

    private string GetConditionBadgeClass(VehicleCondition condition)
    {
        return condition switch
        {
            VehicleCondition.New => "bg-success",
            VehicleCondition.Used => "bg-primary",
            VehicleCondition.CertifiedPreOwned => "bg-info",
            _ => "bg-secondary"
        };
    }

    private string GetFuelTypeDisplayName(FuelType fuelType)
    {
        return fuelType switch
        {
            FuelType.Petrol => "Petrol",
            FuelType.Diesel => "Diesel",
            FuelType.Electric => "Electric",
            FuelType.Hybrid => "Hybrid",
            FuelType.PlugInHybrid => "Plug-in Hybrid",
            FuelType.LPG => "LPG",
            FuelType.CNG => "CNG",
            _ => fuelType.ToString()
        };
    }

    private string GetTransmissionDisplayName(TransmissionType transmission)
    {
        return transmission switch
        {
            TransmissionType.Manual => "Manual",
            TransmissionType.Automatic => "Automatic",
            TransmissionType.CVT => "CVT",
            TransmissionType.SemiAutomatic => "Semi-Automatic",
            _ => transmission.ToString()
        };
    }
}